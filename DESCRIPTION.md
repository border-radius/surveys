# Шкалы обратной связи

## Структура данных

### Пользователи: id, id телеграм аккаунта, fullname из телеграма, секрет, дата создания, обновления и удаления

Существующие пользователи считаются администраторами, могут назначать других пользователей администраторами, создавать новых клиентов, создавать шаблоны опросника и заполнять вопросы и ответы на него, создавать прохождение опросников клиентами.

### Клиенты: id, ФИО, дата создания, обновления и удаления

Пока клиентов будет создавать только администратор через чат-бота

### Шаблоны опросов: id опросника, готовность опросника, название опросника, дата создания, обновления и удаления
### Шаблоны вопросов: id вопроса, id опросника, тип вопроса, текст вопроса, дата создания, обновления и удаления
### Шаблоны ответов: id ответа, id вопроса, текст ответа, дата создания, обновления и удаления

Пока будет только один тип вопроса `range10`: диапазон от 1 до 10. К нему будут относиться два варианта ответа: с меньшим id ответ на 1, в большим id ответ на 10

### Прохождение опросника: id опросника, id клиента, секрет, дата прохождения, дата создания, обновления и удаления
### Ответы на опросник: id прохождения опросника, id вопроса, id ответа, дата создания, обновления и удаления

Для создания прохождения опросника администратор должен будет выбрать опросник и клиента. Бот вернет ссылку с секретом: только по этой ссылке можно будет пройти опроcник единожды.

## Бот

Telegram-бот будет реагировать на следующие команды:

### /start

Возвращает id телеграм пользователя, этот id можно будет переслать другому человеку, чтобы он сделал тебя администратором в боте.
Бот так же указывает, является ли текущий пользователь администратором.

### /promote id

Создает нового пользователя с таким id телеграм аккаунта и случайным секретом. Это делает этого пользователя администратором.

### /clients

Возвращает список клиентов с ссылкой для создания прохождения опроса вида `/survey_add_ID` (ID - id клиента) и кнопку для создания нового клиента. Кнопка отправляет команду `/clients_add`

### /clients_add

Спрашивает у адмнистратора ФИО нового клиента. При получении ответа на это сообщение, создает нового клиента с таким ФИО и уведомляет об этом ответным сообщением.

### /templates

Возвращает список шаблонов опросов и кнопку для создания нового шаблона. Кнопка отправляет команду `/templates_add`

### /templates_add

Спрашивает у администратора название нового опросника.
При получении ответа, создает новый шаблон опросника с таким названием и спрашивает текст первого вопроса.
При получении ответа, создает новый шаблон вопроса с указанным текстом и типом `range10`, в ответ спрашивает первый вариант ответа на этот вопрос (эквивалент ответу 1).
При получении ответа сохраняет шаблон ответа и спрашивает второй вариант ответа на этот вопрос (эквивалент ответу 10).
При получении ответа сохраняет шаблон ответа и спрашивает текст следующего вопроса. У этого сообщения есть кнопка "Завершить опросник", которая отправляет команду `/templates_finish_ID` с ID шаблона опросника.

### /templates_finish_ID (ID - id шаблона опросника)

Обновляет готовность шаблона опросника, позволяя ему отображаться в списке шаблонов опросника.

### /survey_add_ID (ID - id клиента)

Возвращает список шаблонов опросников, у каждого ссылка на создание нового прохождения вида `/survey_add_ID1_ID2` (ID1 - клиент, ID2 - шаблон опросника).

### /survey_add_ID1_ID2 (ID1 - id клиента, ID2 - id шаблона опросника)

Создает новое прохождение опросника и возвращает ссылку него вида: http://localhost:6632/survey/SECRET (SECRET - секрет прохождения опросника).

Так же у бота в подвале имеются кнопки: Клиенты (отправляет `/clients`), Опроcники (отправляет `/templates`), Экспорт (отправляет `/export_SECRET` с секретом текущего пользователя).

## Web-интерфейс

### GET /

Возвращает json формата:

```json
{
    "uptime": 123
}
```

Где `123` - аптайм сервиса в мс.

### GET /survey/SECRET

Находит прохождение опросника и если оно не пройдено (нет даты прохождения), показывает форму с прохождением: название опросника, список вопросов и варианты ответов на него. Для вопросов типа `range10` выводится <input type="range" min="1" max="10" step="1" value="5"> и по бокам у него выводятся первый и второй вариант ответа (первым - с меньшим id). Внизу кнопка "Отправить ответы", отправляющая форму POST-запросом на текущий URI.

### POST /survey/SECRET

Если прохождение опросника еще не пройдено (нет даты прохождения), то сохраняет все ответы на него и обновляет прохождение опросника, устанавливая ему дату прохождения). Рисует задизейбленную форму как в GET-варианте, но с уже проставленными ответами. Над формой надпись: "Спасибо за прохождение опроса. Ваши ответы сохранены.". Рассылает всем администраторам уведомление о том, что такой-то клиент (ФИО) прошел опросник по такому-то шаблону (название шаблона опросника).

### GET /export/SECRET

Если администратор с таким секретом существует, то отправляет всем администраторам сообщение о том, что такой-то администратор заказал экспорт прохождений.
После этого генерирует скачиваемый csv из всех пройденных опросников, отсортированных по клиентам и дате завершения прохождений опросников с такими столбцами: ФИО клиента, название шаблона опросника, дата прохождения, текст вопроса, ответ.